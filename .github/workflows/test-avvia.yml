name: Test Avvia su Windows Pulito

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout progetto
        uses: actions/checkout@v4

      - name: Avvia servizio MySQL (preinstallato su windows-latest)
        run: |
          # Su GitHub Actions il servizio si chiama MySQL80
          $svc = Get-Service -Name "MySQL*" | Select-Object -First 1
          if ($svc) {
            Write-Host "Servizio trovato: $($svc.Name) -> $($svc.Status)"
            Start-Service $svc.Name
            Start-Sleep -Seconds 5
            Write-Host "Stato dopo avvio: $((Get-Service $svc.Name).Status)"
          } else {
            Write-Host "Nessun servizio MySQL trovato"
          }
          # Verifica porta
          Test-NetConnection -ComputerName 127.0.0.1 -Port 3306 -InformationLevel Quiet
        shell: pwsh

      - name: Mostra stato iniziale
        run: |
          java -version 2>&1
          mvn -version 2>&1
          mysql --version 2>&1
        shell: pwsh

      - name: Esegui avvia.ps1
        run: |
          powershell -ExecutionPolicy Bypass -File "${{ github.workspace }}\avvia.ps1" -ScriptDir "${{ github.workspace }}"
        shell: cmd
        timeout-minutes: 20
